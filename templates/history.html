{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-info text-white">
        <h4 class="mb-0">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h4>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <form class="mb-4" id="filterForm">
          <div class="row g-3 align-items-end">
              <div class="col-md-4">
                  <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ß‡πá‡∏ö</label>
                  <select class="form-select" name="agent">
                      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                      {% if unique_agents %}
                          {% for agent in unique_agents|sort %}
                          <option value="{{ agent }}" 
                                  {% if agent|string == selected_agent|string %}selected{% endif %}>
                              {{ agent }}
                          </option>
                          {% endfor %}
                      {% else %}
                          <option disabled>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Agent ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</option>
                      {% endif %}
                  </select>
              </div>
              <div class="col-md-4">
                  <label class="form-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                  <select class="form-select" name="month">
                      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                      {% for my in months_years %}
                      <option value="{{ my._id.month }}" 
                              {% if my._id.month|string == selected_month %}selected{% endif %}>
                          {{ my._id.month }}
                      </option>
                      {% endfor %}
                  </select>
              </div>
              <div class="col-md-4">
                  <label class="form-label">‡∏õ‡∏µ</label>
                  <select class="form-select" name="year">
                      <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                      {% for my in months_years %}
                      <option value="{{ my._id.year }}" 
                              {% if my._id.year|string == selected_year %}selected{% endif %}>
                          {{ my._id.year }}
                      </option>
                      {% endfor %}
                  </select>
              </div>
          </div>
      </form>
      <!-- Summary Cards -->
      <div class="row mb-4">
        {% set total_deposit_all = transactions.items|map(attribute='deposit_amounts')|map('sum')|sum %}
        {% set total_withdrawal_all = transactions.items|map(attribute='withdrawal_amounts')|map('sum')|sum %}
        {% set total_bonus_all = transactions.items|sum(attribute='bonus') %}
        {% set total_commission_all = transactions.items|sum(attribute='commission') %}
        {% set bonus_after_tax = total_bonus_all * 0.83 %}  {# ‡∏´‡∏±‡∏Å 17% ‡∏à‡∏≤‡∏Å‡πÇ‡∏ö‡∏ô‡∏±‡∏™ #}
        {% set total_balance_all = total_deposit_all - (total_withdrawal_all + bonus_after_tax) %}
          <div class="col-md-4 mb-3">
              <div class="card border-success h-100">
                  <div class="card-body">
                      <h5 class="card-title text-success">üíµ ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°</h5>
                      <p class="card-text display-6 text-success">
                        {{ total_deposit_all|number_format(2) }}
                      </p>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card border-danger h-100">
                  <div class="card-body">
                      <h5 class="card-title text-danger">üì§ ‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏°</h5>
                      <p class="card-text display-6 text-danger">
                        {{ total_withdrawal_all|number_format(2) }}
                      </p>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card border-warning h-100">
                  <div class="card-body">
                      <h5 class="card-title text-warning">üí∏ ‡∏ñ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏£‡∏ß‡∏°</h5>
                      <p class="card-text display-6 text-warning">
                        {{ total_commission_all|number_format(2) }}
                      </p>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card border-info h-100">
                  <div class="card-body">
                      <h5 class="card-title text-info">üéÅ ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏°</h5>
                      <p class="card-text display-6 text-info">
                        {{ bonus_after_tax|number_format(2) }}
                      </p>
                  </div>
              </div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card {{ 'border-success' if balance >= 0 else 'border-danger' }} h-100">
                  <div class="card-body">
                      <h5 class="card-title {{ 'text-success' if balance >= 0 else 'text-danger' }}">
                        üßÆ ‡∏¢‡∏≠‡∏î‡∏î‡∏∏‡∏•‡∏£‡∏ß‡∏°
                      </h5>
                      <p class="card-text display-6 {{ 'text-success' if balance >= 0 else 'text-danger' }}">
                        {{ total_balance_all|number_format(2) }}
                      </p>
                  </div>
              </div>
          </div>
      </div>
      <!-- Search Form -->
      <form class="mb-4">
          <div class="input-group">
              <input type="text" 
                     class="form-control" 
                     placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Agent, ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." 
                     name="q"
                     value="{{ request.args.get('q', '') }}">
              <button class="btn btn-primary" type="submit">
                  <i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
              </button>
          </div>
      </form>

        <!-- Transactions List -->
        <div class="list-group">
            {% for transaction in transactions.items %}
            <div class="list-group-item" style="min-height: auto;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h5 class="mb-1">üîÜ {{ transaction.agent }} üîÜ</h5>
                        <small class="text-muted">{{ transaction.date.strftime('%d/%m/%Y') }}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('edit_transaction', transaction_id=transaction._id) }}" 
                            class="btn btn-sm btn-warning">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-primary" 
                                data-bs-toggle="collapse" 
                                data-bs-target="#details-{{ loop.index }}">
                            ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
                        </button>
                        <form method="POST" 
                            action="{{ url_for('delete_transaction', transaction_id=transaction._id) }}"
                            onsubmit="return confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        <a href="/export/{{ transaction._id }}" 
                        class="btn btn-sm btn-success"
                        title="Export to Excel">
                            <i class="fas fa-file-excel"></i>
                        </a>
                    </div>
                </div>

                <!-- Collapsible Details -->
                <div class="collapse mt-3" id="details-{{ loop.index }}">
                    <div class="telegram-message" id="telegram-message-{{ loop.index }}" style="white-space: pre-line; font-family: monospace;">
{%- set deposit_accounts = transaction.get('deposit_accounts', []) %}
{%- set deposit_amounts = transaction.get('deposit_amounts', []) %}
{%- set withdrawal_accounts = transaction.get('withdrawal_accounts', []) %}
{%- set withdrawal_amounts = transaction.get('withdrawal_amounts', []) %}
{%- set mobile_deposit = transaction.get('mobile_deposit', 0) %}
{%- set commission = transaction.get('commission', 0) %}
{%- set bonus = transaction.get('bonus', 0) %}
{%- set transfer = transaction.get('transfer', 0) %}
{%- set db_value = transaction.get('db', 0) %}

{%- set total_deposit = deposit_amounts|sum %}
{%- set total_withdrawal = withdrawal_amounts|sum %}
{%- set total_withdrawal_com = total_withdrawal + commission %}
{%- set atm_balance = total_deposit - (total_withdrawal + commission) %}
{%- set shortfall = transfer - atm_balance %}

{% macro display_accounts(accounts, amounts, total, transaction_type) %}
{% if accounts and amounts and accounts|length == amounts|length %}
{% if transaction_type == 'deposit' %}üí∏ ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å üí∏{% else %}üìµ ‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô üìµ{% endif %}
{% for i in range(accounts|length) %}
‚ñ´Ô∏è{{ accounts[i] }}: {{ amounts[i]|number_format(2) }} ‡∏ö‡∏≤‡∏ó{% endfor %}
‚úÖ ‡∏£‡∏ß‡∏°{% if transaction_type == 'deposit' %}‡∏ù‡∏≤‡∏Å{% else %}‡∏ñ‡∏≠‡∏ô{% endif %}: {{ total|number_format(2) }} ‡∏ö‡∏≤‡∏ó
{% else %}
{% if transaction_type == 'deposit' %}üí∏ ‡∏¢‡∏≠‡∏î‡∏ù‡∏≤‡∏Å üí∏
‚ñ´Ô∏è‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ù‡∏≤‡∏Å{% else %}üìµ ‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô üìµ
‚ñ´Ô∏è‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô{% endif %}
{% endif %}
{% endmacro %}
{{"üîÜ" ~ transaction.agent ~ " ‡∏õ‡∏¥‡∏î‡∏Å‡∏∞üîÜ\n" ~
"‚ñ´Ô∏è‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• : " ~ transaction.date.strftime('%d/%m/%Y') ~ "\n" ~
"‚ñ´Ô∏è‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà : " ~ transaction.new_members|string ~ " ‡∏ù‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß : " ~ transaction.first_deposit|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n" ~
"‚ñ´Ô∏è‡∏ù‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏£‡∏ß‡∏° : " ~ transaction.all_deposit|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"‚ñ´Ô∏è‡πÅ‡∏≠‡∏Ñ‡∏ó‡∏µ‡∏ü : " ~ transaction.used|string ~ " ‡∏Ñ‡∏ô\n\n" ~
"üü¢ Total : " ~ (atm_balance + db_value)|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n" ~
"üü¢ DB : " ~ db_value|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n" ~
"üü¢ ATM : " ~ atm_balance|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"üî∫Total THB ‡∏ä‡∏ô‡∏∞/‡πÅ‡∏û‡πâ : " ~ transaction.profit_thb|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n" ~
"üî∫Total USDT ‡∏ä‡∏ô‡∏∞/‡πÅ‡∏û‡πâ : " ~ transaction.profit_usdt|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó" ~
display_accounts(deposit_accounts, deposit_amounts, total_deposit, 'deposit')~
display_accounts(withdrawal_accounts, withdrawal_amounts, total_withdrawal, 'withdrawal')~
"‚ñ´Ô∏è‡∏ù‡∏≤‡∏Å‡∏°‡∏∑‡∏≠: " ~ mobile_deposit|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"‚ñ´Ô∏è‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: " ~ total_withdrawal|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"‚ñ´Ô∏è‡∏ñ‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°: " ~ commission|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"‚ñ´Ô∏è‡πÇ‡∏ö‡∏ô‡∏±‡∏™: " ~ bonus|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n" ~
"_________________________________________\n\n" ~
"‚úÖ ‡∏£‡∏ß‡∏°‡∏ñ‡∏≠‡∏ô(‡∏¢‡∏≠‡∏î‡∏ñ‡∏≠‡∏ô + ‡∏ñ‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏°) = " ~ total_withdrawal_com|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"‚úÖ ‡∏™‡∏£‡∏∏‡∏õ: " ~ atm_balance|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"üî∞ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏±‡∏Å: " ~ transfer|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó\n\n" ~
"üíµ ‡∏Ç‡∏≤‡∏î/‡πÄ‡∏Å‡∏¥‡∏ô: " ~ shortfall|number_format(2) ~ " ‡∏ö‡∏≤‡∏ó"}}
                    </div>
                    <button class="btn btn-sm btn-outline-secondary copy-btn" 
                            onclick="copyTelegramMessage('telegram-message{{ loop.index }}')">
                        <i class="fas fa-copy me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
                    </button>
                </div>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <i class="fas fa-info-circle me-2"></i>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
            </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if transactions.pages > 1 %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if transactions.has_prev %}
                <li class="page-item">
                    <a class="page-link" 
                    href="{{ url_for('show_history', 
                                    page=transactions.prev_num, 
                                    month=selected_month, 
                                    year=selected_year, 
                                    q=request.args.get('q')) }}">
                        &laquo; ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    </a>
                </li>
                {% endif %}

                {% for page_num in transactions.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == transactions.page %}active{% endif %}">
                            <a class="page-link" 
                            href="{{ url_for('show_history', 
                                            page=page_num, 
                                            month=selected_month, 
                                            year=selected_year, 
                                            q=request.args.get('q')) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if transactions.has_next %}
                <li class="page-item">
                    <a class="page-link" 
                       href="{{ url_for('show_history', 
                                       page=transactions.next_num, 
                                       month=selected_month, 
                                       year=selected_year, 
                                       q=request.args.get('q')) }}">
                        ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
async function copyTelegramMessage(elementId) {
  try {
    const messageElement = document.getElementById(elementId);
    const text = messageElement.innerText;
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ Clipboard API ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
    if (navigator.clipboard) {
      await navigator.clipboard.writeText(text);
      showCopySuccess(elementId);
      return;
    }
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏Å‡πà‡∏≤
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';  // ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô
    document.body.appendChild(textarea);
    textarea.select();
    
    try {
      document.execCommand('copy');
      showCopySuccess(elementId);
    } catch (err) {
      throw new Error('Failed to copy');
    } finally {
      document.body.removeChild(textarea);
    }
    
  } catch (err) {
    console.error('Copy failed:', err);
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
    const messageElement = document.getElementById(elementId);
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î Ctrl+C ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ:\n\n' + messageElement.innerText);
  }
}

function showCopySuccess(elementId) {
  const btn = document.querySelector(`button[onclick*="${elementId}"]`);
  const originalHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-check me-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
  btn.classList.remove('btn-outline-secondary');
  btn.classList.add('btn-success');
  
  setTimeout(() => {
    btn.innerHTML = originalHTML;
    btn.classList.remove('btn-success');
    btn.classList.add('btn-outline-secondary');
  }, 2000);
}

// ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å onclick ‡πÄ‡∏õ‡πá‡∏ô event listener ‡∏ó‡∏µ‡πà‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const elementId = this.closest('.collapse').querySelector('.telegram-message').id;
      copyTelegramMessage(elementId);
    });
  });

  // ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°
  const filterForm = document.getElementById('filterForm');
  if (filterForm) {
    filterForm.querySelectorAll('select').forEach(select => {
      select.addEventListener('change', () => filterForm.submit());
    });
  }
});
</script>
{% endblock %}